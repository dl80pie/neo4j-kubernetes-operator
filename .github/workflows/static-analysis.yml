name: Static Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies and generate manifests
        run: |
          make manifests

      - name: Environment cleanup and sanity checks
        run: |
          echo "Performing environment cleanup and sanity checks..."

          # Check if we're in a Kubernetes environment
          if command -v kubectl &> /dev/null; then
            echo "Kubernetes environment detected, running cleanup..."

            # Test cluster connectivity if available
            if kubectl cluster-info &> /dev/null; then
              echo "Cluster is accessible, running connectivity checks..."
              kubectl cluster-info
              kubectl get nodes --no-headers | wc -l
            else
              echo "No accessible cluster found, skipping cluster operations"
            fi

            # Run cleanup script if available
            if [ -f "scripts/test-cleanup.sh" ]; then
              chmod +x scripts/test-cleanup.sh
              ./scripts/test-cleanup.sh check
            fi
          else
            echo "No Kubernetes environment detected, skipping cleanup"
          fi

          # Clean up any local test artifacts
          rm -rf test-results/ coverage/ logs/ tmp/

          echo "Environment preparation completed"

      - name: Run comprehensive static analysis
        run: |
          echo "Running comprehensive static analysis..."
          make lint-comprehensive

      - name: Run unit tests with race detection
        run: |
          echo "Running unit tests with race detection..."
          make test-unit

      - name: Run tests that don't require a cluster
        run: |
          echo "Running all tests that don't require a cluster..."
          make test-no-cluster

      - name: Check cluster availability for additional tests
        run: |
          echo "Checking cluster availability for additional tests..."
          if ./scripts/check-cluster.sh --verbose; then
            echo "Cluster is available, running integration tests..."
            make test-integration
          else
            echo "No cluster available, skipping integration tests..."
            echo "âœ… Static analysis and unit tests completed successfully"
          fi
