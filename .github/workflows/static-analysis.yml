name: Static Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Environment cleanup and sanity checks
        run: |
          echo "Performing environment cleanup and sanity checks..."

          # Check if we're in a Kubernetes environment
          if command -v kubectl &> /dev/null; then
            echo "Kubernetes environment detected, running cleanup..."

            # Test cluster connectivity if available
            if kubectl cluster-info &> /dev/null; then
              echo "Cluster is accessible, running connectivity checks..."
              kubectl cluster-info
              kubectl get nodes --no-headers | wc -l
            else
              echo "No accessible cluster found, skipping cluster operations"
            fi

            # Run cleanup script if available
            if [ -f "scripts/test-cleanup.sh" ]; then
              chmod +x scripts/test-cleanup.sh
              ./scripts/test-cleanup.sh check
            fi
          else
            echo "No Kubernetes environment detected, skipping cleanup"
          fi

          # Clean up any local test artifacts
          rm -rf test-results/ coverage/ logs/ tmp/

          echo "Environment preparation completed"

      - name: Run comprehensive static analysis
        run: |
          make lint-comprehensive
