name: Webhook TLS Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'internal/webhooks/**'
      - 'config/webhook/**'
      - 'config/certmanager/**'
      - 'config/dev/**'
      - 'test/webhooks/**'
      - 'test/integration/**'
      - '.github/workflows/webhook-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'internal/webhooks/**'
      - 'config/webhook/**'
      - 'config/certmanager/**'
      - 'config/dev/**'
      - 'test/webhooks/**'
      - 'test/integration/**'
      - '.github/workflows/webhook-tests.yml'

env:
  GO_VERSION: '1.21'
  KIND_VERSION: v0.20.0
  KUBECTL_VERSION: v1.28.0
  CERT_MANAGER_VERSION: v1.13.0

jobs:
  webhook-unit-tests:
    name: Webhook Unit Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Run webhook unit tests
      run: |
        make test-webhooks

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: webhook-unit-test-results
        path: |
          coverage/
          test-results/

  webhook-integration-tests:
    name: Webhook Integration Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install Kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/${{ env.KUBECTL_VERSION }}/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Create Kind cluster
      run: |
        cat <<EOF | kind create cluster --config=-
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
          kubeadmConfigPatches:
          - |
            kind: InitConfiguration
            nodeRegistration:
              kubeletExtraArgs:
                node-labels: "ingress-ready=true"
          extraPortMappings:
          - containerPort: 80
            hostPort: 80
            protocol: TCP
          - containerPort: 443
            hostPort: 443
            protocol: TCP
          - containerPort: 30443
            hostPort: 30443
            protocol: TCP
        EOF

    - name: Wait for Kind cluster
      run: |
        kubectl cluster-info --context kind-kind
        kubectl wait --for=condition=ready nodes --all --timeout=300s

    - name: Install cert-manager
      run: |
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/${{ env.CERT_MANAGER_VERSION }}/cert-manager.yaml
        kubectl wait --for=condition=available --timeout=300s deployment/cert-manager -n cert-manager
        kubectl wait --for=condition=available --timeout=300s deployment/cert-manager-webhook -n cert-manager
        kubectl wait --for=condition=available --timeout=300s deployment/cert-manager-cainjector -n cert-manager

    - name: Build operator image
      run: |
        make docker-build IMG=neo4j-operator:test
        kind load docker-image neo4j-operator:test

    - name: Deploy operator with webhooks (development config)
      run: |
        make deploy IMG=neo4j-operator:test KUSTOMIZE_DIR=config/dev
        kubectl wait --for=condition=available --timeout=300s deployment/neo4j-operator-controller-manager -n neo4j-operator-system

    - name: Wait for webhook certificates
      run: |
        kubectl wait --for=condition=ready certificate/serving-cert -n neo4j-operator-system --timeout=120s
        kubectl get secret webhook-server-cert -n neo4j-operator-system

    - name: Run webhook TLS tests
      run: |
        make test-webhooks-tls

    - name: Run webhook integration tests
      run: |
        make test-webhooks-integration

    - name: Test webhook certificate rotation
      run: |
        make test-webhook-cert-rotation

    - name: Collect logs on failure
      if: failure()
      run: |
        echo "=== Operator Logs ==="
        kubectl logs -n neo4j-operator-system deployment/neo4j-operator-controller-manager --tail=100
        echo "=== cert-manager Logs ==="
        kubectl logs -n cert-manager deployment/cert-manager --tail=50
        echo "=== Certificate Status ==="
        kubectl describe certificate serving-cert -n neo4j-operator-system
        echo "=== Webhook Configurations ==="
        kubectl describe validatingwebhookconfiguration neo4j-operator-validating-webhook-configuration
        kubectl describe mutatingwebhookconfiguration neo4j-operator-mutating-webhook-configuration

    - name: Upload integration test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: webhook-integration-test-results
        path: |
          coverage/
          test-results/
          logs/

  webhook-security-tests:
    name: Webhook Security Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install security scanning tools
      run: |
        # Install gosec for security scanning
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        # Install trivy for container scanning
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy

    - name: Run security scans on webhook code
      run: |
        # Scan webhook code for security issues
        gosec -fmt json -out gosec-webhook-report.json ./internal/webhooks/... || true
        # Scan TLS configuration
        gosec -fmt json -out gosec-tls-report.json ./internal/resources/... || true

    - name: Build operator image for security scanning
      run: |
        make docker-build IMG=neo4j-operator:security-test

    - name: Scan container image for vulnerabilities
      run: |
        trivy image --format json --output trivy-report.json neo4j-operator:security-test || true

    - name: Check webhook TLS configuration
      run: |
        # Verify webhook manifests have proper TLS settings
        grep -r "tls" config/webhook/ || echo "No explicit TLS config found"
        # Check certificate configuration
        grep -r "Certificate" config/certmanager/ || echo "No certificate config found"

    - name: Upload security scan results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: webhook-security-scan-results
        path: |
          gosec-*.json
          trivy-report.json

  webhook-performance-tests:
    name: Webhook Performance Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install Kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/${{ env.KUBECTL_VERSION }}/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Create Kind cluster
      run: |
        kind create cluster --wait=300s

    - name: Install cert-manager
      run: |
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/${{ env.CERT_MANAGER_VERSION }}/cert-manager.yaml
        kubectl wait --for=condition=available --timeout=300s deployment/cert-manager -n cert-manager

    - name: Deploy operator
      run: |
        make docker-build IMG=neo4j-operator:perf-test
        kind load docker-image neo4j-operator:perf-test
        make deploy IMG=neo4j-operator:perf-test KUSTOMIZE_DIR=config/dev
        kubectl wait --for=condition=available --timeout=300s deployment/neo4j-operator-controller-manager -n neo4j-operator-system

    - name: Run webhook performance tests
      run: |
        # Test webhook response time under load
        echo "Testing webhook performance..."
        time for i in {1..10}; do
          kubectl apply --dry-run=server -f config/samples/neo4j_v1alpha1_neo4jenterprisecluster.yaml > /dev/null
        done

        echo "Testing concurrent webhook requests..."
        for i in {1..5}; do
          kubectl apply --dry-run=server -f config/samples/neo4j_v1alpha1_neo4jenterprisecluster.yaml > /dev/null &
        done
        wait

    - name: Measure webhook latency
      run: |
        # Create script to measure webhook latency
        cat <<'EOF' > measure_latency.sh
        #!/bin/bash
        TOTAL_TIME=0
        REQUESTS=20

        for i in $(seq 1 $REQUESTS); do
          START=$(date +%s%3N)
          kubectl apply --dry-run=server -f config/samples/neo4j_v1alpha1_neo4jenterprisecluster.yaml > /dev/null
          END=$(date +%s%3N)
          DURATION=$((END - START))
          TOTAL_TIME=$((TOTAL_TIME + DURATION))
          echo "Request $i: ${DURATION}ms"
        done

        AVERAGE=$((TOTAL_TIME / REQUESTS))
        echo "Average latency: ${AVERAGE}ms"

        # Fail if average latency is too high (over 2 seconds)
        if [ $AVERAGE -gt 2000 ]; then
          echo "ERROR: Webhook latency too high: ${AVERAGE}ms"
          exit 1
        fi
        EOF

        chmod +x measure_latency.sh
        ./measure_latency.sh

    - name: Upload performance test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: webhook-performance-results
        path: |
          webhook-performance.log
