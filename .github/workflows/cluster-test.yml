name: Cluster Connectivity Test

on:
  workflow_call:
    inputs:
      cluster-type:
        description: 'Type of cluster to test (kind, openshift, remote)'
        required: true
        default: 'kind'
        type: string
      cluster-name:
        description: 'Name of the cluster'
        required: false
        default: 'neo4j-operator-test'
        type: string
      timeout-minutes:
        description: 'Timeout for cluster operations'
        required: false
        default: '10'
        type: string

jobs:
  test-cluster-connectivity:
    name: Test Cluster Connectivity
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup cluster tools
        run: |
          case "${{ inputs.cluster-type }}" in
            "kind")
              # Install kind if not available
              if ! command -v kind &> /dev/null; then
                curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
                chmod +x ./kind
                sudo mv ./kind /usr/local/bin/kind
              fi
              ;;
            "openshift")
              # Install OpenShift CLI
              curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
              tar -xzf openshift-client-linux.tar.gz
              sudo mv oc /usr/local/bin/
              sudo mv kubectl /usr/local/bin/
              ;;
            "remote")
              # For remote clusters, kubectl should already be available
              echo "Using existing kubectl for remote cluster"
              ;;
          esac

      - name: Validate cluster credentials
        if: inputs.cluster-type == 'openshift'
        run: |
          if [ -z "${{ secrets.OPENSHIFT_SERVER }}" ] || [ -z "${{ secrets.OPENSHIFT_TOKEN }}" ]; then
            echo "❌ OpenShift cluster credentials not available"
            echo "Required secrets: OPENSHIFT_SERVER, OPENSHIFT_TOKEN"
            exit 1
          fi
          echo "✅ OpenShift credentials are configured"

      - name: Create kind cluster
        if: inputs.cluster-type == 'kind'
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: ${{ inputs.cluster-name }}
          config: hack/kind-config.yaml

      - name: Configure kubectl context
        if: inputs.cluster-type == 'kind'
        run: |
          # Ensure kubectl is configured with the correct context
          kubectl config use-context kind-${{ inputs.cluster-name }}

          # Verify cluster connectivity
          echo "Testing cluster connectivity..."
          kubectl cluster-info

          # Check if cluster is ready
          echo "Waiting for cluster to be ready..."
          kubectl wait --for=condition=ready nodes --all --timeout=300s

          # Verify core components are running
          echo "Checking core cluster components..."
          kubectl get nodes -o wide
          kubectl get pods -n kube-system

      - name: Connect to OpenShift cluster
        if: inputs.cluster-type == 'openshift'
        run: |
          # Login to OpenShift cluster
          echo "Logging into OpenShift cluster..."
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }}

          # Test cluster connectivity
          echo "Testing cluster connectivity..."
          oc cluster-info

          # Check cluster status
          echo "Checking cluster status..."
          oc get nodes
          oc get projects

      - name: Test remote cluster connectivity
        if: inputs.cluster-type == 'remote'
        run: |
          # Test cluster connectivity
          echo "Testing remote cluster connectivity..."
          kubectl cluster-info

          # Check cluster status
          echo "Checking cluster status..."
          kubectl get nodes
          kubectl get namespaces

      - name: Verify cluster health
        run: |
          case "${{ inputs.cluster-type }}" in
            "kind"|"remote")
              # Check node status
              echo "Checking node status..."
              kubectl get nodes -o wide

              # Check system pods
              echo "Checking system pods..."
              kubectl get pods -n kube-system

              # Check if API server is responsive
              echo "Testing API server responsiveness..."
              kubectl get --raw /healthz
              ;;
            "openshift")
              # Check node status
              echo "Checking node status..."
              oc get nodes -o wide

              # Check system pods
              echo "Checking system pods..."
              oc get pods -n kube-system

              # Check if API server is responsive
              echo "Testing API server responsiveness..."
              oc get --raw /healthz
              ;;
          esac

      - name: Cleanup kind cluster
        if: always() && inputs.cluster-type == 'kind'
        run: |
          kind delete cluster --name ${{ inputs.cluster-name }} || true
